// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - syncs with Clerk authentication
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  name      String?
  
  // Subscription details
  tier              SubscriptionTier @default(FREE)
  stripeCustomerId  String?          @unique
  subscriptionStatus String?         // active, canceled, past_due, etc.
  subscriptionId    String?
  
  // Preferences
  emailVerified     Boolean  @default(false)
  marketingEmails   Boolean  @default(true)
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  tools     Tool[]
  newsletters Newsletter[]
  
  @@index([email])
  @@index([clerkId])
  @@map("users")
}

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

// AI Tools directory
model Tool {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  tagline     String
  description String   @db.Text
  
  // Media
  logoUrl     String?
  screenshotUrls String[] @default([])
  
  // Links
  websiteUrl  String
  affiliateLink String?
  
  // Categorization
  category    ToolCategory
  tags        String[]  @default([])
  
  // Pricing
  pricing     PricingType
  priceInr    Int?      // Monthly price in INR
  priceUsd    Int?      // Monthly price in USD
  freeTier    Boolean   @default(false)
  
  // Features
  features    String[]  @default([])
  useCases    String[]  @default([])
  
  // Status
  featured    Boolean  @default(false)
  verified    Boolean  @default(false)
  published   Boolean  @default(true)
  
  // Stats
  views       Int      @default(0)
  clicks      Int      @default(0)
  
  // Metadata
  submittedById String?
  submittedBy   User?    @relation(fields: [submittedById], references: [id], onDelete: SetNull)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([slug])
  @@index([category])
  @@index([featured])
  @@map("tools")
}

enum ToolCategory {
  CODE_GENERATION
  IMAGE_VIDEO
  WRITING
  DATA_ANALYSIS
  PRODUCTIVITY
  AUTOMATION
  DESIGN
  RESEARCH
  TRADING
  OTHER
}

enum PricingType {
  FREE
  FREEMIUM
  PAID
  SUBSCRIPTION
  ONE_TIME
}

// Newsletter campaigns
model Newsletter {
  id          String   @id @default(cuid())
  subject     String
  previewText String?
  
  // Topic & Targeting
  topic       NewsletterTopic @default(AI_TOOLS)
  targetTier  SubscriptionTier @default(FREE)  // Minimum tier to receive
  
  // Content
  contentHtml String   @db.Text
  contentJson String?  @db.Text // Store structured content for editing
  aiGenerated Boolean  @default(false)  // Was this auto-generated by AI?
  
  // Metadata
  status      NewsletterStatus @default(DRAFT)
  scheduledFor DateTime?
  sentAt      DateTime?
  
  // Stats
  recipientCount Int      @default(0)
  openCount      Int      @default(0)
  clickCount     Int      @default(0)
  openRate       Float?
  clickRate      Float?
  
  // Relations
  authorId    String?  // Optional for AI-generated newsletters
  author      User?    @relation(fields: [authorId], references: [id])
  emailLogs   EmailLog[]
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status])
  @@index([scheduledFor])
  @@index([topic])
  @@map("newsletters")
}

enum NewsletterStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

enum NewsletterTopic {
  AI_TOOLS
  STOCK_MARKET
  CRYPTO
  STARTUPS
  PRODUCTIVITY
}

// Email subscribers (separate from User for non-authenticated subscribers)
model Subscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  
  // Status
  verified      Boolean  @default(false)
  unsubscribed  Boolean  @default(false)
  
  // Source tracking
  source        String?  // landing_page, referral, import, etc.
  referralCode  String?
  
  // Stripe
  stripeCustomerId  String?  @unique
  
  // Subscription
  tier              SubscriptionTier @default(FREE)
  
  // Newsletter Preferences (topics they want)
  topicAiTools      Boolean  @default(true)
  topicStockMarket  Boolean  @default(true)
  topicCrypto       Boolean  @default(false)
  topicStartups     Boolean  @default(false)
  topicProductivity Boolean  @default(false)
  personalizedDigest Boolean @default(false)  // Premium only
  
  // Email Preferences
  marketingEmails   Boolean  @default(true)
  dailyDigest       Boolean  @default(true)
  productUpdates    Boolean  @default(true)
  
  // Metadata
  subscribedAt  DateTime @default(now())
  unsubscribedAt DateTime?
  lastEmailSent DateTime?
  
  // Relations
  emailLogs EmailLog[]
  
  @@index([email])
  @@index([verified])
  @@map("subscribers")
}

// Email delivery tracking
model EmailLog {
  id            String   @id @default(cuid())
  
  // Relations
  subscriberId  String
  subscriber    Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  newsletterId  String?
  newsletter    Newsletter? @relation(fields: [newsletterId], references: [id], onDelete: SetNull)
  
  // Email details
  emailType     String   // welcome, newsletter, transactional
  subject       String
  
  // Tracking
  sentAt        DateTime @default(now())
  deliveredAt   DateTime?
  openedAt      DateTime?
  clickedAt     DateTime?
  bouncedAt     DateTime?
  complainedAt  DateTime?
  
  // Status
  status        EmailStatus @default(SENT)
  errorMessage  String?
  
  @@index([subscriberId])
  @@index([newsletterId])
  @@index([sentAt])
  @@map("email_logs")
}

enum EmailStatus {
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  FAILED
}

// Sponsor partnerships
model Sponsor {
  id          String   @id @default(cuid())
  
  // Company info
  companyName String
  contactName String
  email       String
  logoUrl     String?
  websiteUrl  String
  
  // Deal details
  dealAmount  Int      // Amount in INR
  currency    String   @default("INR")
  
  // Schedule
  startDate   DateTime
  endDate     DateTime
  
  // Ad placement
  adSlot      SponsorSlot
  adContent   String   @db.Text
  clickUrl    String
  
  // Stats
  impressions Int      @default(0)
  clicks      Int      @default(0)
  
  // Status
  active      Boolean  @default(true)
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([active])
  @@index([startDate])
  @@map("sponsors")
}

enum SponsorSlot {
  NEWSLETTER_TOP
  NEWSLETTER_MIDDLE
  NEWSLETTER_BOTTOM
  WEBSITE_SIDEBAR
  WEBSITE_BANNER
}
